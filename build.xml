<?xml version="1.0"?>
<project xmlns:ext="http://haulmont.com/schema/ant"
	name="workflow" basedir=".">

	<property name="root.dir" location=".."/>

	<import file="${root.dir}/build-inc-prj.xml"/>
	<property file="${root.dir}/build.properties"/>
	<property file="lib.properties"/>

    <property name="jboss.repo" value="${repository.dir}/appservers/jboss-${jboss.version}"/>
    <property name="jbpm.repo" value="${repository.dir}/appservers/jbpm-${jbpm.version}"/>

	<target name="delegate">
		<property name="target" value="noop" />
        <ant dir="modules/core" target="${target}" inheritAll="false"/>
        <ant dir="modules/web" target="${target}" inheritAll="false"/>
        <ant dir="modules/web-war" target="${target}" inheritAll="false"/>
	</target>

	<target name="clean">
		<antcall target="delegate" inheritAll="false">
			<param name="target" value="clean-module"/>
		</antcall>
	</target>
		
	<target name="install-lib">
        <!-- install JMS -->
        <ext:install-files todir="${jboss.deploy.dir}"
                       dir="${jboss.repo}-jms/server/default/deploy" includes="**/*"/>

        <replace dir="${jboss.deploy.dir}/messaging" includes="**/*.xml"
                 token="DefaultDS" value="${datasource.name}"/>

        <!-- install jBPM -->
        <ext:install-files todir="${jboss.default.dir}"
                       dir="${jbpm.repo}/install/src/jboss/config" includes="**/*"/>

        <ext:install-file file="${jbpm.repo}/install/src/cfg/hibernate/datasource/${database}.hibernate.cfg.xml"
                      tofile="${jboss.deploy.dir}/jbpm/jbpm-service.sar/jbpm.hibernate.cfg.xml"/>

        <replace dir="${jboss.deploy.dir}/jbpm" includes="**/*.xml"
                 token="JbpmDS" value="${datasource.name}"/>

        <ext:install-files todir="${jboss.dir}/common/lib"
                       dir="${jbpm.repo}" includes="jbpm.jar"/>

        <ext:install-files todir="${jboss.dir}/common/lib"
                       dir="${jbpm.repo}/lib" includes="jbpm-jboss.jar"/>

        <ext:install-files todir="${jboss.default.dir}/deployers/jbpm.deployer"
                       dir="${jbpm.repo}/lib" includes="jbpm-jboss5.jar"/>

        <copy file="${jboss.dir}/common/lib/jbpm.jar" todir="${lib.server.dir}"/>
        <ext:install-file file="${jbpm.repo}/jbpm-src.zip"
                      tofile="${lib.server.dir}/src/jbpm-src.zip"/>

        <!-- install libs -->
        <ext:install-jboss-lib name="hibernate-core" version="${jboss.version}" toDir="${lib.server.dir}"/>
        <ext:install-jboss-lib name="antlr" version="${jboss.version}" toDir="${lib.server.dir}"/>
    </target>
    
	<target name="compile">
		<antcall target="delegate" inheritAll="false">
			<param name="target" value="compile-module"/>
		</antcall>
	</target>
		
	<target name="build">
		<antcall target="delegate" inheritAll="false">
			<param name="target" value="build-module"/>
		</antcall>
	</target>

    <target name="deploy">
        <antcall target="delegate" inheritAll="false">
            <param name="target" value="deploy-module"/>
        </antcall>
    </target>

    <target name="undeploy">
        <antcall target="delegate" inheritAll="false">
            <param name="target" value="undeploy-module"/>
        </antcall>
    </target>

    <target name="start">
        <exec dir="${root.dir}/jboss/bin" executable="cmd.exe" spawn="true">
            <env key="NOPAUSE" value="true"/>
            <arg line="/c start callAndExit.bat debug.bat -b0.0.0.0"/>
        </exec>
    </target>

    <target name="stop">
        <exec dir="${root.dir}/jboss/bin" executable="cmd.exe">
            <env key="NOPAUSE" value="true"/>
            <arg line="/c start callAndExit.bat shutdown.bat -S"/>
        </exec>
    </target>

    <target name="restart">
        <parallel>
            <antcall target="stop"/>
            <antcall target="deploy"/>
        </parallel>
        <waitfor maxwait="10" maxwaitunit="second" checkevery="2" checkeveryunit="second">
            <not>
                <socket server="localhost" port="8787"/>
            </not>
        </waitfor>
        <antcall target="start"/>
    </target>

    <target name="clean-build-deploy-start" depends="clean,build,deploy,start">
    </target>

    <target name="output">
        <mkdir dir="${output.replace.dir}/deploy"/>
        <mkdir dir="${output.replace.dir}/conf"/>
        <mkdir dir="${output.merge.dir}/deploy"/>
        <mkdir dir="${output.merge.dir}/conf"/>

        <copy todir="${output.replace.dir}/deploy">
            <fileset dir="build">
                <include name="*.jar"/>
                <include name="*.war"/>
                <include name="31workflow-core-service.xml"/>
            </fileset>
        </copy>

        <delete file="${output.replace.dir}/deploy/24cuba.war"/>

        <copy todir="${output.merge.dir}/deploy">
            <fileset dir="build">
                <include name="adbins-ds.xml"/>
            </fileset>
        </copy>

        <copy todir="${output.replace.dir}/conf">
            <fileset dir="build/conf">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>

</project>