<window xmlns="http://schemas.haulmont.com/cuba/4.1/window.xsd"
        class="com.haulmont.workflow.web.ui.base.CardProcFrame"
        messagesPack="com.haulmont.workflow.web.ui.base"
        >

    <dsContext>
        <collectionDatasource id="procDs" class="com.haulmont.workflow.core.entity.Proc" view="_local">
            <query>
                select p from wf$Proc p
                where (p.cardTypes is null or p.cardTypes = '' or p.cardTypes like :custom$cardType) and
                (p.availableRole is null or
                exists (select u from sec$UserRole u where u.user.id =:custom$userId and u.role.id = p.availableRole.id and u.deleteTs is null))
                order by p.name
            </query>
        </collectionDatasource>
        <collectionDatasource id="subProcessCardProcDs" class="com.haulmont.workflow.core.entity.CardProc"
                              view="subprocess">
            <query>
                <![CDATA[select cp from wf$CardProc cp
                where (cp.card.procFamily.jbpmProcessId in (select c.jbpmProcessId from wf$CardProc c where c.id = :custom$cardProc)
                      or (cp.id is not null and cp.id = :custom$cardProc)) and cp.deleteTs is null
                order by cp.createTs]]>
            </query>
        </collectionDatasource>
    </dsContext>

    <layout expand="procRolesSplit">
        <split id="procRolesSplit" orientation="vertical" width="100%">
            <vbox spacing="true" expand="cardProcTable" height="100%">
                <grid spacing="true" width="100%">
                    <columns>
                        <column/>
                        <column/>
                        <column/>
                        <column flex="1"/>
                    </columns>
                    <rows>
                        <row>
                            <lookupField id="createProcLookup" width="150"/>
                            <button id="removeProc" action="cardProcTable.remove" icon="icons/remove.png"/>
                            <button id="startProc" visible="false" icon="icons/run.png" caption=""/>
                        </row>
                    </rows>
                </grid>
                <table id="cardProcTable" width="100%">
                    <columns>
                        <column id="proc.name" caption="msg://process"/>
                        <column id="active" caption="msg://active"/>
                        <column id="startCount" caption="msg://startCount"/>
                        <column id="locState" caption="msg://state"/>
                    </columns>
                    <rows datasource="cardProcDs"/>
                </table>
                <hbox spacing="true">
                    <label id="subProcessLookupLabel" value="msg://subProcessRoleBrowse"/>
                    <lookupField id="subProcessLookup" optionsDatasource="subProcessCardProcDs" captionProperty="card" width="200"/>
                </hbox>

            </vbox>
            <iframe id="cardRolesFrame" screen="cardRolesFrame" width="100%" height="100%"/>
        </split>
    </layout>

</window>
